{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load get_values %}
{% load humanize %}
{% block content %}
    <div class="container justify-content-end py-3 d-flex">
        {% with "autokeras:"|addstr:run.id as run_id %}
            {% if run_id in COMPARISON %}
                <div class='button is-success border'>
                    <i class='fa fa-check mr-3'></i>
                    Bereits im Vergleich
                </div>
            {% else %}
                <button data-id='autokeras:{{ run.id }}'
                        data-name='{{ run.model.project_name }}'
                        data-runtype='autokeras'
                        data-link='{% url 'runs:autokeras:details' run.id %}'
                        class='button'
                        onclick='addRunToComparison(this)'>Vergleichen</button>
            {% endif %}
        {% endwith %}
    </div>
    <div class="container pb-1">
        <div class="card d-none" id='training_progress'>
            <div class="card-header justify-content-between">
                <strong>Trainingsfortschritt</strong>
                <div id="training-tags-" class="d-flex is-align-items-center"></div>
                <div>
                    <a data-tooltip='cancel this task'
                       class="button is-danger"
                       id='task_kill_link'
                       href="{% url 'dashboard:kill_celery_task' 0 %}">
                        <i class="fa fa-times"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="training-progress-bar">
                    <p id="import_job_state_text_"></p>
                    <div class="progress">
                        <progress id="task_progress_"
                                  class="is-link progress progress-bar-animated progress-bar progress-bar-striped"
                                  role="progressbar"
                                  value="0"
                                  min="0"
                                  max="100"></progress>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion" id="accordion_general">
            <div class="card">
                <div data-toggle="collapse"
                     data-target="#collapse_general"
                     class="card-header d-flex justify-content-between is-align-items-center">
                    <h5 class="my-2">General</h5>
                    <i class="fas fa-angle-down"></i>
                </div>
                <div id="collapse_general"
                     class="collapse"
                     aria-labelledby="heading_general"
                     data-parent="#accordion_general">
                    <div class="card-body">
                        {% crispy update_form %}
                        <div class="row">
                            <div class="col-6">
                                <p>
                                    <span class='has-text-weight-bold'>Max trials:</span>
                                    {{ run.model.max_trials }}
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>Max Size:</span>
                                    {{ run.model.max_model_size|intcomma }}
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>Objective:</span>
                                    {{ run.model.objective }}
                                </p>
                                {% if run.model.objective == 'metrics' %}
                                    <p>
                                        <span class='has-text-weight-bold'>Weights:</span>
                                        {{ run.model.metric_weights }}
                                    </p>
                                {% endif %}
                                <p>
                                    <span class='has-text-weight-bold'>Avg. Powerdraw:</span>
                                    {{ run.get_average_power_consumption|floatformat:2 }} W
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>Memory:</span>
                                    {{ run.memory_usage|intcomma }}
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>Size on disk:</span>
                                    {{ run.size_on_disk|intcomma }} Bytes
                                </p>
                            </div>
                            <div class="col-6">
                                <p>
                                    <span class='has-text-weight-bold'>Max Epochs:</span>
                                    {{ run.model.epochs }}
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>NASO Version:</span>
                                    {{ run.naso_app_version }}
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>Git Hash:</span>
                                    {{ run.git_hash }}
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>Device:</span>
                                    {% if run.compute_device %}
                                        {{ run.compute_device }}
                                    {% else %}
                                        {{ run.gpu }}
                                    {% endif %}
                                    on {{ run.worker }}
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>Energy consumption:</span>
                                    {{ run.get_energy_consumption|floatformat:2 }} kWH
                                </p>
                            </div>
                        </div>
                        <div class='row'>
                            <canvas class='h-25 w-100'
                                    style='max-height:100vh'
                                    id='power_plot'
                                    width="400"
                                    height="400"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="" id="accordion_network_graph">
            <div data-toggle="" data-target="#_network_graph" class="card">
                <div class="card-header d-flex justify-content-between is-align-items-center">
                    <h5 class="my-2">Network Graph</h5>
                    <i class="fas fa-angle-down"></i>
                </div>
                <div id="_network_graph"
                     class=" show"
                     aria-labelledby="heading_network_graph"
                     data-parent="#accordion_network_graph">
                    <div class="card-body has-background-light d-flex">{% include 'templates/graph.html' %}</div>
                </div>
            </div>
        </div>
        <!-- create accordion with bulma for optimizer-->
        <div class="accordion" id="accordion_loss">
            <div class="card">
                <div data-toggle="collapse"
                     data-target="#collapse_loss"
                     class="card-header d-flex justify-content-between is-align-items-center"
                     id="heading_loss">
                    <h5 class="my-2">Loss</h5>
                    <div>
                        <span class="mx-5 tag is-info is-light text-md">{{ run.model.loss.instance_type }}</span>
                        <i class="fas fa-angle-down"></i>
                    </div>
                </div>
                <div id="collapse_loss"
                     class="collapse"
                     aria-labelledby="heading_loss"
                     data-parent="#accordion_loss">
                    <div class="card-body">
                        <div class="row">
                            {% if run.model.loss.additional_arguments %}
                                {% for argument in run.model.loss.additional_arguments %}
                                    <div class="col-6">
                                        <p>
                                            <span class='has-text-weight-bold'>{{ argument.name }}</span>
                                            {{ argument.value }}
                                        </p>
                                    </div>
                                {% endfor %}
                            {% else %}
                                {% for argument in run.model.loss.instance_type.required_arguments %}
                                    <div class="col-6">
                                        <p>
                                            <span class='has-text-weight-bold col-2'>{{ argument.name }}</span>
                                            {{ argument.default }}
                                        </p>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% if run.model.pruning_method and run.model.pruning_schedule %}
            <div class="accordion" id="accordion_pruning">
                <div class="card">
                    <div data-toggle="collapse"
                         data-target="#collapse_pruning"
                         class="card-header d-flex justify-content-between is-align-items-center"
                         id="heading_pruning">
                        <h5 class="my-2">Pruning</h5>
                        <div>
                            <span class="mx-5 tag is-info is-light text-md">{{ run.model.pruning_method.instance_type }}</span>
                            <i class="fas fa-angle-down"></i>
                        </div>
                    </div>
                    <div id="collapse_pruning"
                         class="collapse"
                         aria-labelledby="heading_pruning"
                         data-parent="#accordion_pruning">
                        <div class="card-body">
                            <div class="row">
                                {% if run.model.pruning_method.additional_arguments %}
                                    {% for argument in run.model.pruning_method.additional_arguments %}
                                        <div class="col-6">
                                            <p>
                                                <span class='has-text-weight-bold'>{{ argument.name }}</span>
                                                {{ argument.value }}
                                            </p>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    {% for argument in run.model.pruning_method.instance_type.required_arguments %}
                                        <div class="col-6">
                                            <p>
                                                <span class='has-text-weight-bold col-2'>{{ argument.name }}</span>
                                                {{ argument.default }}
                                            </p>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                <div class='w-100 d-flex mt-4'>
                                    <h5 class='w-auto'>Schedule:</h5>
                                    <hr class='w-100 m-3'>
                                </div>
                                {% if run.model.pruning_schedule.additional_arguments %}
                                    {% for argument in run.model.pruning_schedule.additional_arguments %}
                                        <div class="col-6">
                                            <p>
                                                <span class='has-text-weight-bold'>{{ argument.name }}</span>
                                                {{ argument.value }}
                                            </p>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    {% for argument in run.model.pruning_schedule.instance_type.required_arguments %}
                                        <div class="col-6">
                                            <p>
                                                <span class='has-text-weight-bold col-2'>{{ argument.name }}</span>
                                                {{ argument.default }}
                                            </p>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                {% if run.model.pruning_policy %}
                                    <div class='w-100 d-flex mt-4'>
                                        <h5 class='w-auto'>Policy:</h5>
                                        <hr class='w-100 m-3'>
                                    </div>
                                    {% if run.model.pruning_policy.additional_arguments %}
                                        {% for argument in run.model.pruning_policy.additional_arguments %}
                                            <div class="col-6">
                                                <p>
                                                    <span class='has-text-weight-bold'>{{ argument.name }}</span>
                                                    {{ argument.value }}
                                                </p>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        {% for argument in run.model.pruning_policy.instance_type.required_arguments %}
                                            <div class="col-6">
                                                <p>
                                                    <span class='has-text-weight-bold col-2'>{{ argument.name }}</span>
                                                    {{ argument.default }}
                                                </p>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <h4>Metrics</h4>
        {% for metric in run.model.metrics.all %}
            <div class="accordion" id="accordion_{{ metric.id }}">
                <div class="card">
                    <div data-toggle="collapse"
                         data-target="#collapse_{{ metric.id }}"
                         class="card-header d-flex justify-content-between is-align-items-center"
                         id="heading_{{ metric.id }}">
                        <h5 class="my-2">{{ metric.instance_type }}</h5>
                        <i class="fas fa-angle-down"></i>
                    </div>
                    <div id="collapse_{{ metric.id }}"
                         class="collapse"
                         aria-labelledby="heading_{{ metric.id }}"
                         data-parent="#accordion_{{ metric.id }}">
                        <div class="card-body">
                            <div class="">
                                <div>
                                    {% if metric.additional_arguments %}
                                        {% for argument in metric.additional_arguments %}
                                            <p>
                                                <span class='has-text-weight-bold'>{{ argument.name }}</span>
                                                {{ argument.value }}
                                            </p>
                                        {% endfor %}
                                    {% else %}
                                        {% for argument in metric.instance_type.required_arguments %}
                                            <p>
                                                <span class='has-text-weight-bold'>{{ argument.name }}</span>
                                                {{ argument.default }}
                                            </p>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
        <h4>Callbacks</h4>
        {% for callback in run.model.callbacks.all %}
            <div class="accordion" id="accordion_{{ callback.id }}">
                <div class="card">
                    <div data-toggle="collapse"
                         data-target="#collapse_{{ callback.id }}"
                         class="card-header d-flex justify-content-between is-align-items-center"
                         id="heading_{{ callback.id }}">
                        <h5 class="my-2">{{ callback.instance_type }}</h5>
                        <i class="fas fa-angle-down"></i>
                    </div>
                    <div id="collapse_{{ callback.id }}"
                         class="collapse"
                         aria-labelledby="heading_{{ callback.id }}"
                         data-parent="#accordion_{{ callback.id }}">
                        <div class="card-body">
                            <div class="">
                                <div>
                                    {% if callback.additional_arguments %}
                                        {% for argument in callback.additional_arguments %}
                                            <p>
                                                <span class='has-text-weight-bold'>{{ argument.name }}</span>
                                                <span class="border-bottom">{{ argument.value }}</span>
                                            </p>
                                        {% endfor %}
                                    {% else %}
                                        {% for argument in callback.instance_type.required_arguments %}
                                            <p>
                                                <span class='has-text-weight-bold'>{{ argument.name }}</span>
                                                <span class="border-bottom">{{ argument.default }}</span>
                                            </p>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
        <div class="accordion" id="accordion_tuner">
            <div class="card">
                <div data-toggle="collapse"
                     data-target="#collapse_tuner"
                     class="card-header d-flex justify-content-between is-align-items-center"
                     id="heading_tuner">
                    <h5 class="my-2">Tuner</h5>
                    <div>
                        <span class="mx-5 tag is-info is-light text-md">{{ run.model.tuner.tuner_type }}</span>
                        <i class="fas fa-angle-down"></i>
                    </div>
                </div>
                <div id="collapse_tuner"
                     class="collapse"
                     aria-labelledby="heading_tuner"
                     data-parent="#accordion_tuner">
                    <div class="card-body">
                        <div class="row">
                            {% if run.model.tuner.additional_arguments %}
                                {% for argument in run.model.tuner.additional_arguments %}
                                    <div class="col-6">
                                        <p>
                                            <span class='has-text-weight-bold'>{{ argument.name }}</span>
                                            {{ argument.value }}
                                        </p>
                                    </div>
                                {% endfor %}
                            {% else %}
                                {% for argument in run.model.tuner.tuner_type.required_arguments %}
                                    <div class="col-6">
                                        <p>
                                            <span class='has-text-weight-bold col-2'>{{ argument.name }}</span>
                                            {{ argument.default }}
                                        </p>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion" id="accordion_dataset">
            <div class="card">
                <div data-toggle="collapse"
                     data-target="#collapse_dataset"
                     class="card-header d-flex justify-content-between is-align-items-center"
                     id="heading_dataset">
                    <h5 class="my-2">Dataset</h5>
                    <div>
                        <span class="mx-5 tag is-info is-light text-md">{{ run.dataset.name }}</span>
                        <i class="fas fa-angle-down"></i>
                    </div>
                </div>
                <div id="collapse_dataset"
                     class="collapse"
                     aria-labelledby="heading_dataset"
                     data-parent="#accordion_dataset">
                    <div class="card-body">
                        <div class="">
                            <div>
                                <p>
                                    <span class='has-text-weight-bold'>Datasetloader:</span>
                                    {{ run.dataset.dataset_loader }}
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>Information:</span>
                                    {{ run.dataset.description }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion" id="accordion_best_model">
            <div class="card">
                <div data-toggle="collapse"
                     data-target="#collapse_best_model"
                     class="card-header d-flex justify-content-between is-align-items-center"
                     id="heading_best_model">
                    <h5 class="my-2">
                        Best trial: <span id="best_trial_id_container"></span>
                    </h5>
                    <div>
                        <i class="fas fa-angle-down"></i>
                    </div>
                </div>
                <div id="collapse_best_model"
                     class="collapse"
                     aria-labelledby="heading_best_model"
                     data-parent="#accordion_best_model">
                    <div class="card-body">
                        <div class="row">
                            {% if run.prediction_metrics %}
                                {% for metrics in  run.prediction_metrics.first.metrics %}
                                    {% for metric in metrics.metrics %}
                                        <div class="col-6">
                                            <p>
                                                <span class='has-text-weight-bold'>{{ metric }}</span>
                                                {% get_attribute_tag metrics.metrics metric %}
                                            </p>
                                        </div>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion" id="trial_overview">
            <div class="card" style="overflow:visible">
                <div data-toggle="collapse"
                     data-target="#collapse_trials"
                     class="card-header d-flex justify-content-between is-align-items-center"
                     id="heading_trials">
                    <h5 class="my-2">Trial overview</h5>
                    <i class="fas fa-angle-down"></i>
                </div>
                <div id="collapse_trials"
                     class="collapse"
                     aria-labelledby="heading_trials"
                     data-parent="#trial_overview">
                    <div class="card-body">
                        <div class='row'>
                            <div class="col-9" id='trial_overview_container'>
                                <button class='btn btn-primary position-absolute'
                                        style='right: 1%'
                                        onclick='resetTrialOverview()'>Reset Zoom</button>
                                <canvas class='h-100 w-100'
                                        style='max-height:85vh'
                                        id='canvas_trial_overview'
                                        width="400"
                                        height="400"></canvas>
                            </div>
                            <div class="col-3">
                                <div class="axis-selection">
                                    <div>
                                        <label>X-Axis</label>
                                        <select class="form-control"
                                                id="trial_overview_xaxis"
                                                onchange="trialOverviewX(this)">
                                            <option value="epochs">epochs</option>
                                        </select>
                                    </div>
                                    <div class="my-5">
                                        <label>Y-Axis</label>
                                        <select class="form-control"
                                                id="trial_overview_yaxis"
                                                onchange="trialOverviewY(this)"></select>
                                    </div>
                                </div>
                                <div id="trial_selection" class="d-flex flex-wrap justify-content-around"></div>
                            </div>
                        </div>
                        <div class='row bg-gray-light p-5'>
                            <div id="run_overview" class="col-9" style='min-height: 40vh'>
                                <canvas id='canvas_run_overview' width='400' height='400' class='w-100'></canvas>
                            </div>
                            <div id='run_overview_selection' class='col-3'>
                                <div class='d-flex'>
                                    <input type='checkbox'
                                           onchange='includeRegreessionLine(this)'
                                           id='include_regression_check'>
                                    <label for='include_regression_check'>Include regression line</label>
                                </div>
                                <div>
                                    <button class='btn btn-primary' onclick="downloadCSV()">Download as CSV</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion" id="accordion_graphs">
            <div class="card">
                <div data-toggle="collapse"
                     data-target="#collapse_graphs"
                     class="card-header d-flex justify-content-between is-align-items-center"
                     id="heading_graphs">
                    <h5 class="my-2">Graphs</h5>
                    <i class="fas fa-angle-down"></i>
                </div>
                <div id="collapse_graphs"
                     class="collapse"
                     aria-labelledby="heading_graphs"
                     data-parent="#accordion_graphs">
                    <div class="card-body">
                        <div class="" id='canvas_container'>
                            <div id="sorting_container" class="d-flex"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% with run.model.connections as edges %}
        {% include 'components/graph_js.html' %}
    {% endwith %}
    <script>
        let run_metrics = {};
        let trialOverviewChart = null;
        let allEpochs = [];
        const COMPARISONS = [{% for id, model in COMPARISON.items %}'{{ id }}',{% endfor %}]
        document.addEventListener("DOMContentLoaded", () => {
            let powerCanvas = document.getElementById("power_plot").getContext('2d');
            powerCanvas = new Chart(powerCanvas, {
                type: 'line',
                data: {
                    labels: {{ run.get_times }},
                    datasets: [{
                        data: {{ run.get_power_measurements }},
                        label: "Power consumption"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'time [s]'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Power' // Set the dynamic Y-axis title
                            }
                        }
                    },
                    plugins: {
                        colors: {
                            forceOverride: true
                        },
                    }
                }
            });
            let canvas = document.getElementById("canvas_trial_overview").getContext('2d');
            let runOverview = document.getElementById("canvas_run_overview").getContext('2d');
            runOverviewChart = new Chart(runOverview, {
                type: 'scatter',
                data: {
                    datasets: [],
                },
                plugins: [{
                    afterDraw: function(chart) {
                        var check = document.getElementById("include_regression_check");
                        if (!check.checked) {
                            return;
                        }
                        var datasets = chart.data.datasets;
                        let displayedDatasetIndex = 0;
                        for (var i = 0; i < datasets.length; i++) {
                            var dataset = datasets[i];
                            var regression = calculateRegressionLine(dataset.data);

                            var ctx = chart.ctx;

                            ctx.save();
                            if (dataset.hidden) {
                                continue;
                            }
                            var minX = Math.min(...dataset.data.map(point => point.x));
                            var maxX = Math.max(...dataset.data.map(point => point.x));

                            ctx.save();
                            ctx.beginPath();
                            if (displayedDatasetIndex == 2) {
                                ctx.moveTo(chart.scales.x.getPixelForValue(minX), chart.scales.y3.getPixelForValue(regression.intercept + regression.slope * minX));
                                ctx.lineTo(chart.scales.x.getPixelForValue(maxX), chart.scales.y3.getPixelForValue(regression.intercept + regression.slope * maxX));
                            } else if (displayedDatasetIndex == 1) {
                                ctx.moveTo(chart.scales.x.getPixelForValue(minX), chart.scales.y2.getPixelForValue(regression.intercept + regression.slope * minX));
                                ctx.lineTo(chart.scales.x.getPixelForValue(maxX), chart.scales.y2.getPixelForValue(regression.intercept + regression.slope * maxX));
                            } else {
                                ctx.moveTo(chart.scales.x.getPixelForValue(minX), chart.scales.y.getPixelForValue(regression.intercept + regression.slope * minX));
                                ctx.lineTo(chart.scales.x.getPixelForValue(maxX), chart.scales.y.getPixelForValue(regression.intercept + regression.slope * maxX));
                            }
                            ctx.strokeStyle = dataset.borderColor;
                            ctx.lineWidth = 2;
                            ctx.stroke();
                            ctx.restore();
                            displayedDatasetIndex += 1;
                        }
                    },
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                text: "Trial",
                                display: true,
                                font: {
                                    size: 20
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                text: "Trial",
                                display: true,
                                font: {
                                    size: 20
                                }
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                text: "Trial",
                                display: true,
                                font: {
                                    size: 20
                                }
                            }
                        },
                        y3: {
                            display: false,
                            title: {
                                font: {
                                    size: 20
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: false,
                            text: '{{ run.model.project_name }}',
                        },
                        legend: {
                            labels: {
                                filter: function(legendItem, data) {
                                    return legendItem && !legendItem.hidden;
                                },
                                generateLabels: function(chart) {
                                    var data = chart.data;
                                    if (data.datasets.length) {
                                        let labels = data.datasets.map(function(dataset, index) {
                                            if (!dataset.hidden) {
                                                return {
                                                    text: dataset.label === 'metrics' ? "objective" : dataset.label.replaceAll("_", " "),
                                                    fillStyle: dataset.backgroundColor, // Assuming only one dataset
                                                    fontColor: dataset.backgroundColor,
                                                    strokeStyle: dataset.borderColor,
                                                    hidden: false,
                                                    index: index
                                                };
                                            }
                                        });
                                        return labels;
                                    }
                                    return [];
                                },
                                parse: true,
                                font: {
                                    size: 20
                                }
                            }
                        },
                    }
                }
            });
            trialOverviewChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: allEpochs,
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Epochs' // Set the dynamic X-axis title
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Loss' // Set the dynamic Y-axis title
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        colors: {
                            forceOverride: true
                        },
                        zoom: {
                            enabled: true,
                            mode: 'y',
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderColor: 'rgb(255, 99, 132)',
                                    borderWidth: 1,
                                    modifierKey: 'ctrl'
                                },
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy'
                            },
                        },
                        tooltip: {
                            enabled: false,
                            position: 'nearest',
                            external: externalTooltipHandler
                        }
                    }
                }
            });

            fetch("{% url 'api:autokeras:inference_metrics' run.id %}").then(function(response) {
                response.json().then(function(data) {
                    var runDatasets = [];
                    for (trial_id in data) {
                        let x = Number(trial_id);

                        for (const metric in data[trial_id]) {
                            if (metric === 'trial_id') {
                                continue;
                            }
                            let y = data[trial_id][metric];
                            if (metric in runDatasets) {
                                runDatasets[metric].data.push({
                                    'x': x,
                                    "y": y
                                });
                            } else {
                                runDatasets[metric] = {
                                    'label': metric,
                                    'data': [{
                                        'x': x,
                                        "y": y
                                    }],
                                    'hidden': true
                                };
                            }
                        }

                    }
                    var csvData = [['metric']];
                    for(const key in runDatasets) {
                        dataset = runDatasets[key];
                        console.log(dataset['label']);
                        csvData.push([
                            dataset['label'], 
                            ...dataset['data'].map((datapoint) =>{
                                return datapoint['y'];
                            })
                        ]);
                    }
                    for(const f in csvData[1]) {
                        csvData[0][f] = f;
                    }
                    csvData[0][0] = 'metric';
                    window.autokerasData = csvData;
                    runOverviewChart.data.datasets = Object.values(runDatasets);
                    runOverviewChart.update();

                    let selectionContainer = $('#run_overview_selection');
                    let selectionHTML = "";
                    for (dataset in runDatasets) {
                        selectionHTML += "<div class='me-2'><input type='checkbox' data-metric='" + snake_case_string(dataset) + "' id='run_metric_" + snake_case_string(dataset) + "'><label for='run_metric_" + dataset + "'>" + dataset + "</label></div>";
                    }
                    selectionContainer.append(selectionHTML);
                    for (dataset in runDatasets) {
                        $('#run_metric_' + snake_case_string(dataset)).change(function() {
                            let metric = this.getAttribute('data-metric');
                            let shownCount = 0;
                            for (dataset of runOverviewChart.data.datasets) {
                                if (!dataset.hidden) {
                                    shownCount++;
                                }
                            }
                            for (dataset of runOverviewChart.data.datasets) {
                                if (metric === snake_case_string(dataset.label)) {
                                    dataset.hidden = !dataset.hidden;
                                    if (dataset.hidden) {
                                        shownCount -= 1;
                                    }
                                    dataset.borderColor = SetTwo8[shownCount % 8];
                                    dataset.backgroundColor = SetTwo8[shownCount % 8];
                                    if (shownCount == 1) {
                                        runOverviewChart.options.scales.y3.display = false;
                                        runOverviewChart.options.scales.y2.display = true;
                                        runOverviewChart.options.scales.y2.title.color = dataset.borderColor;
                                        runOverviewChart.options.scales.y2.title.text = metric === 'metrics' ? "objective" : metric.replaceAll("_", " ");
                                        runOverviewChart.options.scales.y2.title.font.size = 20;
                                        dataset.yAxisID = 'y2';
                                    } else if (shownCount > 1) {
                                        dataset.backgroundColor = SetTwo8[shownCount % 8];
                                        runOverviewChart.options.scales['y3'] = {
                                            display: true,
                                            position: 'right',
                                            title: {
                                                display: true,
                                                text: metric === 'metric' ? "objective" : metric,
                                                font: {
                                                    size: 20
                                                },
                                                color: dataset.borderColor
                                            }
                                        };
                                        dataset.yAxisID = 'y3';
                                    } else {
                                        runOverviewChart.options.scales.y2.display = false;
                                        runOverviewChart.options.scales.y3.display = false;
                                        runOverviewChart.options.scales.y.title.color = dataset.borderColor;
                                        runOverviewChart.options.scales.y.title.text = metric === 'metrics' ? "objective" : metric.replaceAll("_", " ");
                                        runOverviewChart.options.scales.y.title.font.size = 20;
                                        dataset.yAxisID = 'y';
                                    }
                                }
                            }
                            runOverviewChart.update();
                        });
                    }
                });
            });

            fetch("{% url 'api:autokeras:metrics_short' run.id %}").then(function(response) {
                response.json().then(function(data) {
                    run_metrics = data;
                    var run_metrics_names = run_metrics['metrics'];
                    delete run_metrics.metrics;
                    let firstTrialID = undefined;

                    for (trial_id in run_metrics) {
                        if (!firstTrialID) {
                            firstTrialID = trial_id;
                        }
                        let trial_data = run_metrics[trial_id];
                        let canvas_html = "<div class='has-background-white-bis my-5 p-3 rounded-lg'"; for (metric in run_metrics[trial_id]['min']) { canvas_html += " data-min-" + snake_case_string(metric) + "='" + run_metrics[trial_id]['min'][metric] + "'"; } for (metric in run_metrics[trial_id]['max']) { canvas_html += " data-max-" + metric + "='" + run_metrics[trial_id]['max'][metric] + "'"; } canvas_html += "><h6 onclick='loadTrial(`" + trial_id + "`)' class='text-center mt-5' style='cursor: pointer'>Trial " +
                            (trial_id) + "</h6><div class='d-flex'><div class='col-9'><canvas class='h-100 w-100 d-none' id='canvas_trial_" + trial_id + "' width='400' height='400'></canvas></div><div id='canvas_configure_" + trial_id + "' class='col-3'></div></div>" +
                            "<div class='row p-3 border-top mt-5 d-none' id='trial_details_container_" + trial_id + "'></div></div>";
                        $("#canvas_container").append(canvas_html);

                        // now add teh checkbox to trial_selection for the trial overview
                        let checkBoxHTML = '<div class="me-2"><input type="checkbox" data-trial=' + trial_id + ' class="form-check-inline" id="trial_checkbox_' + trial_id + '"><label for="trial_checkbox_' + trial_id + '">Trial ' + (trial_id) + '</label></div>';
                        $('#trial_selection').append(checkBoxHTML);
                        $('#trial_checkbox_' + trial_id).change(function() {
                            let trial_id = this.getAttribute('data-trial');
                            if (this.checked) {
                                if (!('data' in run_metrics[trial_id])) {
                                    fetch("{% url 'api:autokeras:get_metrics' run.id '-1e' %}".replace('-1e', trial_id), {
                                        method: "GET",
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Token ${token}`
                                        }
                                    }).then(function(response) {
                                        response.json().then(function(data) {
                                            run_metrics[trial_id]['data'] = data;
                                            trialOverviewChart.data.datasets.push({
                                                label: 'Trial ' + (trial_id),
                                                data: dictToArray(data, $("#trial_overview_yaxis").val(), $('#trial_overview_xaxis').val()),
                                                id: trial_id
                                            });
                                            trialOverviewChart.update();
                                        });
                                    });
                                } else {
                                    trialOverviewChart.data.datasets.push({
                                        label: 'Trial ' + (trial_id),
                                        data: dictToArray(run_metrics[trial_id]['data'], $("#trial_overview_yaxis").val(), $('#trial_overview_xaxis').val()),
                                        id: trial_id
                                    });
                                    trialOverviewChart.update();
                                }
                            } else {
                                index = trialOverviewChart.data.datasets.findIndex(x => x.id == trial_id);
                                trialOverviewChart.data.datasets.splice(index, 1);
                                trialOverviewChart.update();
                            }
                        });

                    }

                    let metrics = [];
                    for (metric of run_metrics_names) {
                        metrics.push(snake_case_string(metric));
                        generateOption(metric, metric, $('#trial_overview_xaxis'));
                        generateOption(metric, metric, $('#trial_overview_yaxis'));
                    }
                    generateSortSelect('canvas_container', metrics);

                    fetchTrialDetails();

                    let minObjective = undefined;
                    let objective = '{{run.model.objective}}'
                    let bestTrial = undefined
                    for (const trial in run_metrics) {
                        metrics = run_metrics[trial]['min'];
                        if (!minObjective || metrics[objective] < minObjective) {
                            minObjective = metrics[objective];
                            bestTrial = trial;
                        }
                    }
                    $('#best_trial_id_container').html(' ' + bestTrial);

                    var select = $('#sortSelect');
                    for (metric in run_metrics[firstTrialID]['final']) {
                        generateOption('eval' + capitalizeFirstLetter(metric) + ':asc', "Test data " + metric + ' (Ascending)', select);
                        generateOption('eval' + capitalizeFirstLetter(metric) + ':desc', "Test data " + metric + ' (Descending)', select);
                    }
                });
            });

            fetch("{% url 'api:celery:is_running' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Token ${token}`,
                },
                body: JSON.stringify({
                    'run_id': {{ run.id }},
                    'run_type': 'autokeras'
                }),
            }).then(function(response) {
                response.json().then(function(data) {
                    console.log(data);
                    if (data['success']) {
                        $('#training_progress').toggleClass('d-none');
                        // this run is currently in training, so display the progreessbar
                        $('#task_kill_link').attr('href', $('#task_kill_link').attr('href').replace(0, data['task_id']));
                        updateProgress("{% url 'runs:training_progress' 0 %}".replace(0, data['task_id']), '');
                    }
                });
            });

        });

        function includeRegreessionLine(el) {
            if (runOverviewChart) {
                runOverviewChart.update();
            }
        }

        function fetchTrialDetails() {
            fetch("{% url 'api:autokeras:trial_details' run.id %}").then(function(response) {
                response.json().then(function(data) {
                    // for every trial in data, append a div to trial_container_<trial_id> and fill in the values from data[trial_id]:
                    for (trial_id in data) {
                        let trial_data = data[trial_id];
                        let trial_html = "";
                        for (hp in trial_data) {
                            trial_html += "<div class='col-3'><span class='has-text-weight-bold'>" + hp + ":</span> " + trial_data[hp] + "</div>";
                        }
                        $("#trial_details_container_" + trial_id).append(trial_html);
                    }
                });
            });
        }

        function dictToArray(dict, key, xAxisMetric = 'epochs') {
            let array = [];
            for (let i in dict) {
                var label = '';
                if (xAxisMetric == 'epochs') {
                    label = i.toString();
                } else {
                    label = dict[i][xAxisMetric].toString();
                }
                array.push({
                    y: dict[i][key],
                    x: label
                });
            }
            return array;
        }

        const getOrCreateTooltip = (chart) => {
            let tooltipEl = chart.canvas.parentNode.querySelector('div');

            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.style.background = 'rgba(0, 0, 0, 0.7)';
                tooltipEl.style.borderRadius = '3px';
                tooltipEl.style.color = 'white';
                tooltipEl.style.opacity = 1;
                tooltipEl.style.pointerEvents = 'none';
                tooltipEl.style.position = 'absolute';
                tooltipEl.style.transform = 'translate(-50%, 0)';
                tooltipEl.style.width = 'max-content';
                tooltipEl.style.zIndex = 9999;
                const table = document.createElement('table');
                table.style.margin = '0px';

                tooltipEl.appendChild(table);
                chart.canvas.parentNode.appendChild(tooltipEl);
            }

            return tooltipEl;
        };

        const externalTooltipHandler = (context) => {
            // Tooltip Element
            const {
                chart,
                tooltip
            } = context;
            const tooltipEl = getOrCreateTooltip(chart);

            // Hide if no tooltip
            if (tooltip.opacity === 0) {
                tooltipEl.style.opacity = 0;
                return;
            }

            let dataIndex = tooltip.dataPoints[0].dataIndex;

            // Set Text
            if (tooltip.body) {
                const titleLines = tooltip.title || [];
                const bodyLines = tooltip.body.map(b => b.lines);

                const tableHead = document.createElement('thead');

                titleLines.forEach(title => {
                    const tr = document.createElement('tr');
                    tr.style.borderWidth = 0;

                    const th = document.createElement('th');
                    th.style.borderWidth = 0;
                    th.style.color = 'white';
                    const text = document.createTextNode($('#trial_overview_xaxis').val() + " " + title);

                    th.appendChild(text);
                    tr.appendChild(th);
                    tableHead.appendChild(tr);
                });

                const tableBody = document.createElement('tbody');
                bodyLines.forEach((body, i) => {
                    let metrics = run_metrics[tooltip.dataPoints[i].dataset.id]['data'][dataIndex];
                    const colors = tooltip.labelColors[i];
                    const span = document.createElement('span');
                    span.style.background = colors.backgroundColor;
                    span.style.borderColor = colors.borderColor;
                    span.style.borderWidth = '2px';
                    span.style.height = '10px';
                    span.style.width = '10px';
                    span.style.display = 'inline-block';

                    const tr = document.createElement('tr');
                    tr.style.backgroundColor = 'inherit';
                    tr.style.borderWidth = 0;

                    const td = document.createElement('td');
                    td.style.borderWidth = 0;

                    let bodyText = body + ', Modelsize: ' + metrics['model_size'].toLocaleString()
                    if ('trial_power_consumption' in metrics) {
                        bodyText += ', Power: ' + metrics['trial_power_consumption'].toLocaleString() + ' W';
                    }
                    const text = document.createTextNode(bodyText);

                    td.appendChild(span);
                    td.appendChild(text);
                    tr.appendChild(td);
                    tableBody.appendChild(tr);
                });

                const tableRoot = tooltipEl.querySelector('table');

                // Remove old children
                while (tableRoot.firstChild) {
                    tableRoot.firstChild.remove();
                }

                // Add new children
                tableRoot.appendChild(tableHead);
                tableRoot.appendChild(tableBody);
            }

            const {
                offsetLeft: positionX,
                offsetTop: positionY
            } = chart.canvas;

            // Display, position, and set styles for font
            tooltipEl.style.opacity = 1;
            tooltipEl.style.left = positionX + tooltip.caretX + 'px';
            tooltipEl.style.top = positionY + tooltip.caretY + 'px';
        };

        function resetTrialOverview() {
            fitAxesToData(trialOverviewChart);
        }

        function trialOverviewX(event) {
            let xaxis = $('#trial_overview_xaxis').val();
            let yaxis = $('#trial_overview_yaxis').val();
            trialOverviewChart.data.datasets.forEach(function(dataset) {
                dataset.data = dictToArray(run_metrics[dataset.id], yaxis, xaxis);
            });
            trialOverviewChart.options.scales.x.title.text = xaxis;
            trialOverviewChart.update();
        }

        function trialOverviewY(event) {
            let yaxis = $('#trial_overview_yaxis').val();
            trialOverviewChart.data.datasets.forEach(function(dataset) {
                dataset.data = dictToArray(run_metrics[dataset.id], yaxis, $('#trial_overview_xaxis').val());
            });
            trialOverviewChart.options.scales.y.title.text = yaxis;
            trialOverviewChart.update();
        }

        function generateOption(value, text, parent) {
            let optionY = document.createElement('option');
            optionY.value = value;
            optionY.text = text;
            parent.append(optionY);
        }

        function loadTrial(trialId) {
            $("#canvas_trial_" + trialId).toggleClass("d-none");
            if ($("#canvas_configure_" + trialId).children().length === 0) {
                if ('data' in run_metrics[trialId]) {
                    build_graph(trialId, run_metrics[trialId]['data']);
                } else {
                    fetch("{% url 'api:autokeras:get_metrics' run.id '-1e' %}".replace('-1e', trialId), {
                        method: "GET",
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Token ${token}`
                        }
                    }).then(function(response) {
                        response.json().then(function(data) {
                            run_metrics[trialId]['data'] = data;
                            build_graph(trialId, data);
                        });
                    });
                }
            }
        }

        function build_graph(trial_id, trial_data) {
            //$("#trial_details_container_" + trial_id).toggleClass("d-none");

            let canvas = document.getElementById("canvas_trial_" + trial_id).getContext('2d');
            var data = [];
            var labels = [];

            var dropdownX = document.createElement('select');
            var dropdownY = document.createElement('select');
            var configButton = document.createElement('button');
            var hideDetailsButton = document.createElement("button");

            dropdownX.className = 'form-control mb-5';
            dropdownY.className = 'form-control mb-3';
            configButton.className = 'btn btn-primary my-2 col-8';
            configButton.innerHTML = 'Set for all';
            hideDetailsButton.className = 'btn btn-primary my-2 col-8';
            hideDetailsButton.innerHTML = 'Show Details';
            dropdownX.name = 'xaxis';
            dropdownY.name = 'yaxis';

            let optionX = document.createElement('option');
            optionX.value = 'epochs';
            optionX.text = 'epochs';
            dropdownX.appendChild(optionX);

            for (let key in trial_data[0]) {
                if (trial_data[0].hasOwnProperty(key)) {
                    generateOption(key, key, dropdownX);
                    generateOption(key, key, dropdownY);
                }
            }
            if (trial_data[0].hasOwnProperty('model_size')) {
                $("#canvas_configure_" + trial_id).append('<span class="text-bold">Model size:</span> ' + trial_data[0]['model_size'].toLocaleString() + '<br>');
            }
            for (var metric in trial_data['final']) {
                $("#canvas_configure_" + trial_id).append('<span class="text-bold">' + metric + ' on eval data</span> ' + trial_data['final'][metric].toLocaleString() + '<br>');
            }
            $("#canvas_configure_" + trial_id).append('<label>X-Axis</label>');
            $("#canvas_configure_" + trial_id).append(dropdownX);
            $("#canvas_configure_" + trial_id).append('<label>Y-Axis</label>');
            $("#canvas_configure_" + trial_id).append(dropdownY);
            $("#canvas_configure_" + trial_id).append(configButton);
            $("#canvas_configure_" + trial_id).append(hideDetailsButton);
            $("#canvas_configure_" + trial_id).append('<a href="{% url 'api:autokeras:all_metrics' run.id %}' + trial_id + '/download" class="my-2 col-8 btn btn-primary">Download CSV</a>');
            let trialLink = "{% url 'runs:autokeras:trial' run.id 'naso.trial_id' %}".replace('naso.trial_id', trial_id);
            $('#canvas_configure_' + trial_id).append('<br><a href="' + trialLink + '" class="btn btn-primary col-8 my-2">Rerun</a> ');
            if (COMPARISONS.includes("{{ run.id }}_" + trial_id)) {
                $('#canvas_configure_' + trial_id).append('<br><div class="button is-success col-8 my-2"><i class="fa fa-check mr-3"></i>Im Vergleich</div> ');
            } else {
                $('#canvas_configure_' + trial_id).append('<br><button onclick="addRunToComparison(this)" data-link="" data-name="Trial ' + trial_id + ' von {{ run.model.project_name }}" data-runtype="autokeras_trial" data-id="{{ run.id }}_' + trial_id + '" class="btn btn-primary col-8 my-2">Vergleichen</button> ');
            }

            let maxMetrics = getMaxValuesPerTrial(trial_data);
            for (let metric in maxMetrics) {
                if (maxMetrics.hasOwnProperty(metric)) {
                    $('#canvas_configure_' + trial_id).parent().parent().attr('data-max-' + snake_case_string(metric), maxMetrics[metric]);
                }
            }
            for (metric in trial_data['final']) {
                $('#canvas_configure_' + trial_id).parent().parent().attr('data-eval-' + snake_case_string(metric), trial_data['final'][metric]);
            }

            let minMetrics = getMinValuesPerTrial(trial_data);
            for (let metric in minMetrics) {
                if (minMetrics.hasOwnProperty(metric)) {
                    $('#canvas_configure_' + trial_id).parent().parent().attr('data-min-' + snake_case_string(metric), minMetrics[metric]);
                }
            }
            hideDetailsButton.addEventListener("click", function() {
                $("#trial_details_container_" + trial_id).toggleClass("d-none");
            });

            configButton.addEventListener('click', function() {
                var xaxis = document.getElementsByName('xaxis');
                xaxis.forEach(element => {
                    element.value = dropdownX.value;
                    element.dispatchEvent(new Event('change'));
                });
                var yaxis = document.getElementsByName('yaxis');
                yaxis.forEach(element => {
                    element.value = dropdownY.value;
                    element.dispatchEvent(new Event('change'));
                });
            });

            dropdownX.addEventListener('change', function() {
                labels = [];
                if (dropdownX.value == 'epochs') {
                    for (let epoch in trial_data) {
                        labels.push(epoch);
                    }
                } else {
                    for (let epoch in trial_data) {
                        labels.push(trial_data[epoch][dropdownX.value]);
                    }
                }
                updateChart();
            });

            dropdownY.addEventListener('change', function() {
                if (dropdownY.value == 'metrics') {
                    // show stacked bar chart:
                    let weights = {{ run.model.metric_weights | safe }};
                    let trialEpochs = [];
                    let index = 0;
                    for (const metricName in weights) {
                        let barData = [];
                        for (epoch in trial_data) {
                            trialEpochs.push(epoch);
                            barData.push(weights[metricName] * Number(trial_data[epoch][metricName]));
                        }
                        trialChart.data.datasets[index] = {
                            label: metricName,
                            data: barData,
                        };
                        index += 1;
                    }
                    trialChart.data.labels = trialEpochs;
                    trialChart.options.scales.x.stacked = true;
                    trialChart.options.scales.y.stacked = true;
                    trialChart.config.type = 'bar';
                    trialChart.update();
                } else {
                    data = [];
                    for (let epoch in trial_data) {
                        data.push(trial_data[epoch][dropdownY.value]);
                    }
                    trialChart.data.datasets = [{
                        label: dropdownY.value
                    }]
                    trialChart.options.scales = {
                        x: {
                            type: 'linear'
                        }
                    };
                    trialChart.config.type = 'line';
                    updateChart();
                }
            });

            function updateChart() {
                trialChart.data.labels = [];
                trialChart.data.datasets[0].data = dictToArray(trial_data, dropdownY.value, dropdownX.value);
                trialChart.update();
                console.log('update');
            }

            for (let epoch in trial_data) {
                data.push(trial_data[epoch][dropdownY.value]);
                labels.push(epoch);
            }

            if (labels.length > trialOverviewChart.data.labels.length) {
                allEpochs = labels;
                trialOverviewChart.data.labels = labels;
            }

            var trialChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: dropdownY.value,
                        data: data,
                        id: trial_id,
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'linear'
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                }
            });

        }

        function getMaxValuesPerTrial(trial_data) {
            let maxValues = {};

            for (const epoch in trial_data) {
                for (let metric in trial_data[epoch]) {
                    if (trial_data[epoch].hasOwnProperty(metric)) {
                        if (!maxValues[metric] || trial_data[epoch][metric] > maxValues[metric]) {
                            maxValues[metric] = trial_data[epoch][metric];
                        }
                    }
                }
            }

            return maxValues;
        }

        function getMinValuesPerTrial(trial_data) {
            let minValues = {};

            for (const epoch in trial_data) {
                for (let metric in trial_data[epoch]) {
                    if (trial_data[epoch].hasOwnProperty(metric)) {
                        if (!minValues[metric] || trial_data[epoch][metric] < minValues[metric]) {
                            minValues[metric] = trial_data[epoch][metric];
                        }
                    }
                }
            }

            return minValues;
        }

        function sortDivsByMetric(parentDivId, metric, sortOrder) {
            const parentDiv = document.getElementById(parentDivId);
            const divs = Array.from(parentDiv.querySelectorAll('div.rounded-lg'));

            usePrefix = true;
            if (metric.indexOf('eval') >= 0) {
                usePrefix = false;
            }
            divs.sort((a, b) => {
                var metricName = metric;
                console.log(metricName);
                if (sortOrder === 'asc') {
                    if (usePrefix) {
                        metricName = `min${metric}`;
                    }
                    if (!metricName in a.dataset || !metricName in b.dataset) {
                        return 0;
                    }
                    const aValue = parseFloat(a.dataset[metricName]);
                    const bValue = parseFloat(b.dataset[metricName]);
                    return aValue - bValue;
                } else {
                    if (usePrefix) {
                        metricName = `max${metric}`;
                    }
                    if (!metricName in a.dataset || !metricName in b.dataset) {
                        return 0;
                    }
                    const aValue = parseFloat(a.dataset[metricName]);
                    const bValue = parseFloat(b.dataset[metricName]);
                    return bValue - aValue;
                }
            });

            divs.forEach(div => {
                parentDiv.appendChild(div);
            });
        }


        function generateSortSelect(parentDivId, availableMetrics) {
            const parentDiv = $('#sorting_container');

            const select = document.createElement('select');
            select.classList.add('form-control');
            select.setAttribute('id', 'sortSelect');
            select.addEventListener('change', function() {
                const selectedOption = this.value;
                const selectedMetric = selectedOption.split(':')[0];
                const sortOrder = selectedOption.split(':')[1];
                sortDivsByMetric(parentDivId, selectedMetric, sortOrder);
            });

            availableMetrics.forEach(metric => {
                const metricCapitalized = metric.charAt(0).toUpperCase() + metric.slice(1);

                generateOption(metricCapitalized + ':asc', metricCapitalized + ' (Ascending by lowest temporal value)', select);
                generateOption(metricCapitalized + ':desc', metricCapitalized + ' (Descending by highest temporal value)', select);
            });

            parentDiv.append('<label>Sort by</label>');
            parentDiv.append(select);

        }

        function downloadCSV(filename = '{{ run.model.project_name }}.csv') {
            var arrayData = window.autokerasData;
            // Step 1: Convert array of data to CSV format
            const csvContent = arrayData.map(row => row.join(",")).join("\n");

            // Step 2: Create a Blob from the CSV data
            const blob = new Blob([csvContent], { type: 'text/csv' });

            // Step 3: Create a link element and set its href to the Blob URL
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;

            // Step 4: Append the link to the body and trigger a click to start download
            document.body.appendChild(a);
            a.click();

            // Step 5: Cleanup the DOM and revoke the object URL
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
{% endblock %}
