{% extends 'base.html' %}

{% load crispy_forms_tags %}
{% load static %}

{% block content %}
<div class="tabs is-centered">
    <ul>
        <li class="tab is-active" onclick="openTab(event,'tensorflow-tab')">
            <a>Tensorflow</a>
        </li>
        <li class="tab" onclick="openTab(event,'autokeras-tab')">
            <a>Autokeras</a>
        </li>
    </ul>
</div>
<div class="container pb-5">
    <div id="tensorflow-tab" class="content-tab">
        
    {% if form %}
        {% crispy form  %}
    {% elif running_task %}
        <div class="card">
            <div class="card-body">
                Es lauft bereits ein Training.
                <a href="{{running_task.url}}">{{running_task.title}}</a>
            </div>
        </div>
    {% endif %}

    </div>
    <div id="autokeras-tab" class="content-tab">
        Autokeras
    </div>
    
    <script src="{% static 'js/sigma.min.js' %}"></script>
    <script src="{% static 'js/sigma.plugins.dragnodes.js' %}"></script>
    <script src="{% static 'js/graphs.js' %}"></script>
    {% block javascript %}
    {{ block.super }}
    <script>
        $(document).ready(function() {
            handleOptimizerChange($('#{{form.optimizer.auto_id}}'));
            handleLossChange($('#{{form.loss.auto_id}}'));
            handleMetricChange($('#{{form.metrics.auto_id}}'));
            handleLayerChange($('#{{form.layers.auto_id}}'));
            openTab({currentTarget:$('.tab.is-active')[0]}, 'tensorflow-tab');
            {% if nodes and edges%}
                // load the nodes an dedegs into the graph
                edges = {{edges | safe}};
                nodes.clear();
                load_nodes = {{nodes | safe}};
                nodes.set('start', { id: "input_node", label: "Input", x: 0, y: load_nodes[0]['y'] - 1, size: 3, color: '#008cc2' });
                for(const node of load_nodes) {
                    nodes.set(node.id, node);
                }
                // we dont need this anymore.
                delete load_nodes;
                refreshGraph();
            {% endif %}
            {% if optimizer_config %}
                // load the optimizer values
                let existing_optimizer = {{optimizer_config | safe}};
                for (const argument of existing_optimizer) {
                    document.getElementsByName('optimizer_argument_' + argument.name)[0].value = argument.value
                }
                delete existing_optimizer;
            {% endif %}

            {% if loss_config %}
                // load the loss values
                let existing_loss = {{loss_config | safe}};
                for (const argument of existing_loss) {
                    document.getElementsByName('loss_argument_' + argument.name)[0].value = argument.value
                }
                delete existing_loss;
            {% endif %}

            {% if metric_configs %}
                // load the loss values
                let existing_metrics = {{metric_configs | safe}};
                for (const metric of existing_metrics) {
                    for(const argument of metric['arguments']) {
                        let fields = document.getElementsByName('metric_argument_' + metric['id'] + "_" + argument.name);
                        if (fields[0]) {
                            fields[0].value = argument.value;
                        }
                    }
                }
                delete existing_metrics;
            {% endif %}
        }
        );
        const False = false;
        const True = true;
        const None = undefined;
var optimizerOptions = [
        {% for optimizer in form.optimizer.field.queryset %}
            {
                "id": {{ optimizer.id }},
                "name": "{{ optimizer.name }}",
                "jsonConfig": {{ optimizer.required_arguments|safe|default:"{}" }},
            },
        {% endfor %}
    ];

    var lossOptions = [
        {% for loss in form.loss.field.queryset %}
            {
                "id": {{ loss.id }},
                "name": "{{ loss.name }}",
                "jsonConfig": {{ loss.required_arguments|safe|default:"{}" }},
            },
        {% endfor %}
    ];

    var metricOptions = [
        {% for metric in form.metrics.field.queryset %}
            {
                "id": {{ metric.id }},
                "name": "{{ metric.name }}",
                "jsonConfig": {{ metric.required_arguments|safe|default:"{}" }},
            },
        {% endfor %}
    ];

    var layerOptions = [
        {% for layer in form.layers.field.queryset %}
            {
                "id": {{ layer.id }},
                "name": "{{ layer.name }}",
                "jsonConfig": {{ layer.required_arguments|safe|default:"{}" }},
            },
        {% endfor %}
    ];


    </script>
    {% endblock javascript %}
</div>
{% endblock content %}