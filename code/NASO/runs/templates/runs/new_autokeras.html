{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
<div class="container pb-5">
    
    <div class="tabs is-centered is-toggle is-toggle-round">
        <ul>
            <li class="tab">
                <a href="{% url 'runs:new' %}">Tensorflow</a>
            </li>
            <li class="tab is-active">
                <a>Autokeras</a>
            </li>
        </ul>
    </div>
    {% if form %}
        <div id="tensorflow-tab" class="content-tab">
            {% crispy form  %}
        </div>
    {% endif %}
    </div>
    <script src="{% static 'js/sigma.min.js' %}"></script>
    <script src="{% static 'js/sigma.plugins.dragnodes.js' %}"></script>
    <script src="{% static 'js/graphs.js' %}"></script>
{% block javascript %}
    {{block.super}}
    <script>
        $(document).ready(function() {
            handleKerasTunerChange($('#{{form.tuner.auto_id}}'));
            handleKerasBlockChange($('#{{form.layers.auto_id}}'));
            handleMetricChange($('#{{form.metrics.auto_id}}'));
            handleCallbackChange($('#{{form.callbacks.auto_id}}'));
            
            nodes.clear();
            refreshGraph();

            {% if nodes and edges%}
                // load the nodes an dedegs into the graph
                edges = {{edges | safe}};
                nodes.clear();
                load_nodes = {{nodes | safe}};
                for(const node of load_nodes) {
                    nodes.set(node.id, node);
                }
                // we dont need this anymore.
                delete load_nodes;
                refreshGraph();
            {% endif %}
            {% if tuner_config %}
                // load the tuner values
                let existing_tuners = {{tuner_config | safe}};
                for (const argument of existing_tuners) {
                    document.getElementsByName('tuner_argument_' + argument.name)[0].value = argument.value
                }
                delete existing_tuners;
            {% endif %}

            {% if loss_config %}
                // load the loss values
                let existing_loss = {{loss_config | safe}};
                for (const argument of existing_loss) {
                    document.getElementsByName('loss_argument_' + argument.name)[0].value = argument.value
                }
                delete existing_loss;
            {% endif %}
            {% if metric_configs %}
                // load the metric values
                let existing_metrics = {{metric_configs | safe}};
                for (const metric of existing_metrics) {
                    for(const argument of metric['arguments']) {
                        let fields = document.getElementsByName('metric_argument_' + metric['id'] + "_" + argument.name);
                        if (fields[0]) {
                            fields[0].value = argument.value;
                        }
                    }
                }
                delete existing_metrics;
            {% endif %}
            {% if callbacks_configs %}
                // load the callback values
                let existing_callbacks = {{callbacks_configs | safe}};
                for (const callback of existing_callbacks) {
                    for(const argument of callback['arguments']) {
                        let fields = document.getElementsByName('callback_argument_' + callback['id'] + "_" + argument.name);
                        if (fields[0]) {
                            fields[0].value = argument.value;
                        }
                    }
                }
                delete existing_callbacks;
            {% endif %}

        }
        );
        const False = false;
        const True = true;
        const None = undefined;
        var kerasTunerOptions = [
        {% for kerasTuner in form.tuner.field.queryset %}
            {
                "id": {{ kerasTuner.id }},
                "name": "{{ kerasTuner.name }}",
                "jsonConfig": {{ kerasTuner.required_arguments|safe|default:"{}" }},
            },
        {% endfor %}
    ];
    var kerasBlocksOptions = [
        {% for kerasBlocks in form.layers.field.queryset %}
            {
                "id": {{ kerasBlocks.id }},
                "name": "{{ kerasBlocks.name }}",
                "jsonConfig": {{ kerasBlocks.required_arguments|safe|default:"{}" }},
            },
        {% endfor %}
    ];
    var metricOptions = [
        {% for metric in form.metrics.field.queryset %}
            {
                "id": {{ metric.id }},
                "name": "{{ metric.name }}",
                "jsonConfig": {{ metric.required_arguments|safe|default:"{}" }},
            },
        {% endfor %}
    ];
    var callbackOptions = [
        {% for callback in form.callbacks.field.queryset %}
            {
                "id": {{ callback.id }},
                "name": "{{ callback.name }}",
                "jsonConfig": {{ callback.required_arguments|safe|default:"{}" }},
            },
        {% endfor %}
    ];

    </script>
    {% endblock javascript%}
{% endblock content %}