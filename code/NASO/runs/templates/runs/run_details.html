{% extends 'base.html' %}
{% load get_values %}
{% block content %}

<div class="container pb-1">
    <div class="accordion" id="accordion_general">
    <div data-toggle="collapse" data-target="#collapse_general" class="card">
        <div class="card-header d-flex justify-content-between is-align-items-center">
            <h5 class="my-2">
                General
            </h5>
            <i class="fas fa-angle-down"></i>
        </div>
        <div id="collapse_general" class="collapse" aria-labelledby="heading_general" data-parent="#accordion_general">
        <div class="card-body">
            <div class="row">
                <div class="col-6">
                    <p>
                        <span class='has-text-weight-bold'>Max trials:</span>
                        {{ run.model.max_trials }}
                    </p>
                    <p>
                        <span class='has-text-weight-bold'>Max Size:</span>
                        {{ run.model.max_model_size }}
                    </p>
                    <p>
                        <span class='has-text-weight-bold'>Objective:</span>
                        {{ run.model.objective }}
                    </p>
                    {% if run.model.objective == 'metrics' %}
                        <p>
                            <span class='has-text-weight-bold'>Weights:</span>
                            {{ run.model.metric_weights }}
                        </p>
                    {% endif %}
                    
                </div>
                <div class="col-6">                   
                    <p>
                        <span class='has-text-weight-bold'>Max Epochs:</span>
                        {{ run.model.epochs }}
                    </p>
                    <p>
                        <span class='has-text-weight-bold'>NASO Version:</span>
                        {{ run.naso_app_version }}
                    </p>
                    <p>
                        <span class='has-text-weight-bold'>Git Hash:</span>
                        {{ run.git_hash }}
                    </p>
                </div>
            </div>
        </div>
        </div>
    </div>
    </div>
    <!-- create accordion with bulma for optimizer-->
    <div class="accordion" id="accordion_loss">
        <div class="card">
            <div data-toggle="collapse" data-target="#collapse_loss" class="card-header d-flex justify-content-between is-align-items-center" id="heading_loss">
                <h5 class="my-2">
                    Loss
                </h5>
                <div>
                    <span class="mx-5 tag is-info is-light text-md">{{ run.model.loss.instance_type }}</span>
                    <i class="fas fa-angle-down"></i>
                </div>
            </div>

            <div id="collapse_loss" class="collapse" aria-labelledby="heading_loss" data-parent="#accordion_loss">
                <div class="card-body">
                    <div class="row">
                        {% if run.model.loss.additional_arguments %}
                            {% for argument in run.model.loss.additional_arguments %}
                                <div class="col-6">
                                    <p>
                                        <span class='has-text-weight-bold'>{{argument.name}}</span>
                                        {{argument.value}}
                                    </p>
                                </div>
                            {% endfor %}
                        {% else %}
                            {% for argument in run.model.loss.instance_type.required_arguments %}
                            <div class="col-6">
                                <p>
                                    <span class='has-text-weight-bold col-2'>{{argument.name}}</span>
                                    {{argument.default}}
                                </p>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <h4>
        Metrics
    </h4>
    {% for metric in run.model.metrics.all %}
    <div class="accordion" id="accordion_{{metric.id}}">
        <div class="card">
            <div data-toggle="collapse" data-target="#collapse_{{metric.id}}" class="card-header d-flex justify-content-between is-align-items-center" id="heading_{{metric.id}}">
                <h5 class="my-2">
                    {{metric.instance_type}}                    
                </h5>
                <i class="fas fa-angle-down"></i>
            </div>

            <div id="collapse_{{metric.id}}" class="collapse" aria-labelledby="heading_{{metric.id}}" data-parent="#accordion_{{metric.id}}">
                <div class="card-body">
                    <div class="">                       
                            <div>
                                {% if metric.additional_arguments %}
                                    {% for argument in metric.additional_arguments %}
                                    <p>
                                        <span class='has-text-weight-bold'>{{argument.name}}</span>
                                        {{argument.value}}
                                    </p>
                                    {% endfor %}
                                {% else %}
                                    {% for argument in metric.instance_type.required_arguments %}
                                    <p>
                                        <span class='has-text-weight-bold'>{{argument.name}}</span>
                                        {{argument.default}}    
                                    </p>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <h4>
        Callbacks
    </h4>
    {% for callback in run.model.callbacks.all %}
    <div class="accordion" id="accordion_{{callback.id}}">
        <div class="card">
            <div data-toggle="collapse" data-target="#collapse_{{callback.id}}" class="card-header d-flex justify-content-between is-align-items-center" id="heading_{{callback.id}}">
                <h5 class="my-2">
                    {{callback.instance_type}}
                </h5>
                <i class="fas fa-angle-down"></i>
            </div>

            <div id="collapse_{{callback.id}}" class="collapse" aria-labelledby="heading_{{callback.id}}" data-parent="#accordion_{{callback.id}}">
                <div class="card-body">
                    <div class="">                       
                            <div>
                                {% if callback.additional_arguments %}
                                    {% for argument in callback.additional_arguments %}
                                    <p>
                                        <span class='has-text-weight-bold'>{{argument.name}}</span>
                                        <span class="border-bottom">{{argument.value}}</span>
                                    </p>
                                    {% endfor %}
                                {% else %}
                                    {% for argument in callback.instance_type.required_arguments %}
                                    <p>
                                        <span class='has-text-weight-bold'>{{argument.name}}</span>
                                        <span class="border-bottom">{{argument.default}}</span>
                                    </p>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    <div class="accordion" id="accordion_tuner">
        <div class="card">
            <div data-toggle="collapse" data-target="#collapse_tuner" class="card-header d-flex justify-content-between is-align-items-center" id="heading_tuner">
                <h5 class="my-2">
                    Tuner
                </h5>
                <div>
                    <span class="mx-5 tag is-info is-light text-md">{{ run.model.tuner.tuner_type }}</span>
                    <i class="fas fa-angle-down"></i>
                </div>
            </div>

            <div id="collapse_tuner" class="collapse" aria-labelledby="heading_tuner" data-parent="#accordion_tuner">
                <div class="card-body">
                    <div class="row">                       
                        {% if run.model.tuner.additional_arguments %}
                            {% for argument in run.model.tuner.additional_arguments %}
                                <div class="col-6">
                                    <p>
                                        <span class='has-text-weight-bold'>{{argument.name}}</span>
                                        {{argument.value}}
                                    </p>
                                </div>
                            {% endfor %}
                        {% else %}
                            {% for argument in run.model.tuner.tuner_type.required_arguments %}
                            <div class="col-6">
                                <p>
                                    <span class='has-text-weight-bold col-2'>{{argument.name}}</span>
                                    {{argument.default}}
                                </p>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion" id="accordion_dataset">
        <div class="card">
            <div data-toggle="collapse" data-target="#collapse_dataset" class="card-header d-flex justify-content-between is-align-items-center" id="heading_dataset">
                <h5 class="my-2">
                    Dataset
                </h5>
                <div>
                    <span class="mx-5 tag is-info is-light text-md">{{ run.dataset.name }}</span>
                    <i class="fas fa-angle-down"></i>
                </div>
            </div>

            <div id="collapse_dataset" class="collapse" aria-labelledby="heading_dataset" data-parent="#accordion_dataset">
                <div class="card-body">
                    <div class="">                       
                            <div>
                                <p>
                                    <span class='has-text-weight-bold'>Datasetloader:</span>
                                    {{ run.dataset.dataset_loader }}
                                </p>
                                <p>
                                    <span class='has-text-weight-bold'>Information:</span>
                                    {{ run.dataset.description }}
                                </p>
                            </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion" id="trial_overview">
        <div class="card">
            <div data-toggle="collapse" data-target="#collapse_trials" class="card-header d-flex justify-content-between is-align-items-center" id="heading_trials">
                <h5 class="my-2">
                    Trial overview
                </h5>
                <i class="fas fa-angle-down"></i>
            </div>

            <div id="collapse_trials" class="collapse" aria-labelledby="heading_trials" data-parent="#trial_overview">
                <div class="card-body d-flex">
                    <div class="col-9" id='trial_overview_container'>
                        <canvas class='h-100 w-100' id='canvas_trial_overview'></canvas>
                    </div>
                    <div class="col-3">
                        <div class="axis-selection">
                            <div>
                                <label>X-Axis</label>
                                <select class="form-control" id="trial_overview_xaxis" onchange="trialOverviewX(this)">
                                    <option value="epochs">epochs</option>
                                </select>
                            </div>
                            <div class="my-5">
                                <label>Y-Axis</label>
                                <select class="form-control" id="trial_overview_yaxis" onchange="trialOverviewY(this)">
                                </select>
                            </div>
                        </div>
                        <div id="trial_selection">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion" id="accordion_graphs">
        <div class="card">
            <div data-toggle="collapse" data-target="#collapse_graphs" class="card-header d-flex justify-content-between is-align-items-center" id="heading_graphs">
                <h5 class="my-2">
                    Graphs
                </h5>
                <i class="fas fa-angle-down"></i>
            </div>

            <div id="collapse_graphs" class="collapse" aria-labelledby="heading_graphs" data-parent="#accordion_graphs">
                <div class="card-body">

                    <div class="" id='canvas_container'>                       
                          <div id="sorting_container" class="d-flex"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    let run_metrics = {};
    let trialOverviewChart = null;
    let allEpochs = [];
    document.addEventListener("DOMContentLoaded", () => {
        let canvas = document.getElementById("canvas_trial_overview").getContext('2d');
        trialOverviewChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: allEpochs,
                datasets: []
            },
            options: {
                plugins: {
                    colors: {
                        forceOverride: true
                    }
                }
            }
        });

        fetch("{% url 'api:autokeras:all_metrics' run.id %}").then(function(response) {
            response.json().then(function(data) {
                run_metrics = data;
                let firstTrialID = undefined;

                for (trial_id in run_metrics) {
                    if (!firstTrialID) {
                        firstTrialID = trial_id;
                    }
                    let trial_data = run_metrics[trial_id];
                    let canvas_html = "<div class='has-background-white-bis my-5 p-3 rounded-lg'><h6 class='text-center mt-5'>Trial " + 
                        (trial_id) + "</h6><div class='d-flex'><div class='col-9'><canvas class='h-100 w-100' id='canvas_trial_" + 
                        trial_id + "'></canvas></div><div id='canvas_configure_" + trial_id + "' class='col-3'></div></div>" + 
                        "<div class='row p-3 border-top mt-5' id='trial_details_container_" + trial_id + "'></div></div>";
                    $("#canvas_container").append(canvas_html);                    
                    build_graph(trial_id, trial_data);

                    // now add teh checkbox to trial_selection for the trial overview
                    let checkBoxHTML = '<div><input type="checkbox" data-trial=' + trial_id + ' class="form-check-inline" id="trial_checkbox_'+trial_id+'"><label for="trial_checkbox_'+trial_id+'">Trial '+(trial_id)+'</label></div>';
                    $('#trial_selection').append(checkBoxHTML);
                    $('#trial_checkbox_'+trial_id).change(function() {
                        let trial_id = this.getAttribute('data-trial');
                        if(this.checked) {
                            trialOverviewChart.data.datasets.push({
                                label: 'Trial '+(trial_id),
                                data: dictToArray(run_metrics[trial_id],$("#trial_overview_yaxis").val()),
                                id: trial_id
                            });
                            trialOverviewChart.update();
                        } else {
                            index = trialOverviewChart.data.datasets.findIndex(x => x.id == trial_id);
                            trialOverviewChart.data.datasets.splice(index, 1);
                            trialOverviewChart.update();
                        }
                    });
                    
                }
                let metrics = [];
                for(metric in run_metrics[firstTrialID][0]) {
                    metrics.push(metric);
                    generateOption(metric, metric, $('#trial_overview_xaxis'));
                    generateOption(metric, metric, $('#trial_overview_yaxis'));
                }
                generateSortSelect('canvas_container', metrics);
            });
        });
        fetch("{% url 'api:autokeras:trial_details' run.id %}").then(function(response) {
            response.json().then(function(data) {
                // for every trial in data, append a div to trial_container_<trial_id> and fill in the values from data[trial_id]:
                for (trial_id in data) {
                    let trial_data = data[trial_id];
                    let trial_html = "";
                    for (hp in trial_data) {
                        trial_html += "<div class='col-3'><span class='has-text-weight-bold'>" + hp + ":</span> " + trial_data[hp] + "</div>";
                    }
                    $("#trial_details_container_" + trial_id).append(trial_html);
                }
            });
        });
    });

    function dictToArray(dict, key) {
        let array = [];
        for (let i in dict) {
            array.push(dict[i][key]);
        }
        return array;
    }

    function trialOverviewX(event) {
        let xaxis = $('#trial_overview_xaxis').val();
        if (xaxis == 'epochs') {
            trialOverviewChart.data.labels = allEpochs;
            trialOverviewChart.update();
        } else {
            trialOverviewChart.data.labels = dictToArray(run_metrics[0], xaxis);
            trialOverviewChart.update();
        }
    }

    function trialOverviewY(event) {
        let yaxis = $('#trial_overview_yaxis').val();
        trialOverviewChart.data.datasets.forEach(function(dataset) {
            dataset.data = dictToArray(run_metrics[dataset.id], yaxis);
        });
        trialOverviewChart.update();
    }

    function generateOption(value, text, parent) {
        let optionY = document.createElement('option');
        optionY.value = value;
        optionY.text = text;
        parent.append(optionY);
    }
    
    function build_graph(trial_id, trial_data) {
        $("#trial_details_container_"+trial_id).toggleClass("d-none");        

        let canvas = document.getElementById("canvas_trial_" + trial_id).getContext('2d');
        var data = [];
        var labels = [];

        var dropdownX = document.createElement('select');
        var dropdownY = document.createElement('select');
        var configButton = document.createElement('button');
        var hideDetailsButton = document.createElement("button");

        dropdownX.className='form-control mb-5';
        dropdownY.className='form-control mb-3';
        configButton.className='btn btn-primary my-2 col-8';
        configButton.innerHTML = 'Set for all';
        hideDetailsButton.className='btn btn-primary my-2 col-8';
        hideDetailsButton.innerHTML = 'Show Details';
        dropdownX.name = 'xaxis';
        dropdownY.name = 'yaxis';

        let optionX = document.createElement('option');
        optionX.value = 'epochs';
        optionX.text = 'epochs';
        dropdownX.appendChild(optionX);
        
        for (let key in trial_data[0]) {
            if (trial_data[0].hasOwnProperty(key)) {
                generateOption(key, key, dropdownX);
                generateOption(key, key, dropdownY);
            }
        }
        if(trial_data[0].hasOwnProperty('model_size')) {
            $("#canvas_configure_"+trial_id).append('<span class="text-bold">Model size:</span> '+trial_data[0]['model_size'].toLocaleString()+'<br>');
        }
        $("#canvas_configure_"+trial_id).append('<label>X-Axis</label>');
        $("#canvas_configure_"+trial_id).append(dropdownX);
        $("#canvas_configure_"+trial_id).append('<label>Y-Axis</label>');
        $("#canvas_configure_"+trial_id).append(dropdownY);
        $("#canvas_configure_"+trial_id).append(configButton);
        $("#canvas_configure_"+trial_id).append(hideDetailsButton);

        let maxMetrics = getMaxValuesPerTrial(trial_data);
        for (let metric in maxMetrics) {
            if (maxMetrics.hasOwnProperty(metric)) {
                $('#canvas_configure_'+trial_id).parent().parent().attr('data-max-'+metric, maxMetrics[metric]);
            }
        }

        hideDetailsButton.addEventListener("click", function() {
            $("#trial_details_container_"+trial_id).toggleClass("d-none");
        });

        configButton.addEventListener('click', function () {
            var xaxis = document.getElementsByName('xaxis');
            xaxis.forEach(element => {
                element.value = dropdownX.value;
                element.dispatchEvent(new Event('change'));
            });
            var yaxis = document.getElementsByName('yaxis');
            yaxis.forEach(element => {
                element.value = dropdownY.value;
                element.dispatchEvent(new Event('change'));
            });
        });

        dropdownX.addEventListener('change', function () {
            labels=[];
            if (dropdownX.value == 'epochs') {
                for (let epoch in trial_data) {
                    labels.push(epoch);
                }
            } else {
                for (let epoch in trial_data) {
                    labels.push(trial_data[epoch][dropdownX.value]);
                }
            }
            updateChart();
        });

        dropdownY.addEventListener('change', function () {
            data =[];
            for (let epoch in trial_data) {
                data.push(trial_data[epoch][dropdownY.value]);
            }
            updateChart();
        });

        function updateChart() {
            trialChart.data.labels = labels;
            trialChart.data.datasets[0].data = data;
            trialChart.update();
            console.log('update');
        }

        for (let epoch in trial_data) {
            data.push(trial_data[epoch][dropdownY.value]);
            labels.push(epoch);
        }

        if (labels.length > trialOverviewChart.data.labels.length) {
            allEpochs = labels;
            trialOverviewChart.data.labels = labels;
        }

        var trialChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: dropdownY.value,
                    data: data,
                }]
            }
        });
    
    }

    function getMaxValuesPerTrial(trial_data) {
        let maxValues = {};

        for(const epoch in trial_data) {
            for (let metric in trial_data[epoch]) {
                if (trial_data[epoch].hasOwnProperty(metric)) {
                    if (!maxValues[metric] || trial_data[epoch][metric] > maxValues[metric]) {
                        maxValues[metric] = trial_data[epoch][metric];
                    }
                }
            }
        }
        
        return maxValues;
    }

    function sortDivsByMetric(parentDivId, metric, sortOrder) {
    const parentDiv = document.getElementById(parentDivId);
    const divs = Array.from(parentDiv.querySelectorAll('div.rounded-lg'));

    divs.sort((a, b) => {
        const aValue = parseFloat(a.dataset[`max${metric}`]);
        const bValue = parseFloat(b.dataset[`max${metric}`]);
        if (sortOrder === 'asc') {
            return aValue - bValue;
        } else {
            return bValue - aValue;
        }
    });

    divs.forEach(div => {
        parentDiv.appendChild(div);
    });
}


    function generateSortSelect(parentDivId, availableMetrics) {
        const parentDiv = $('#sorting_container');

        const select = document.createElement('select');
        select.classList.add('form-control');
        select.setAttribute('id', 'sortSelect');
        select.addEventListener('change', function () {
            const selectedOption = this.value;
            const selectedMetric = selectedOption.split(':')[0];
            const sortOrder = selectedOption.split(':')[1];
            sortDivsByMetric(parentDivId, selectedMetric, sortOrder);
        });

        availableMetrics.forEach(metric => {
            const metricCapitalized = metric.charAt(0).toUpperCase() + metric.slice(1);

            generateOption(metricCapitalized + ':asc', metricCapitalized + ' (Ascending)', select);
            generateOption(metricCapitalized + ':desc', metricCapitalized + ' (Descending)', select);
        });

        parentDiv.append('<label>Sort by</label>');
        parentDiv.append(select);
    }

</script>
{% endblock %}