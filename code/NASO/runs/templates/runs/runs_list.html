{% extends 'base.html' %}

{% load get_values %}

{% block content %}

<div class="container">
    <div class="row">
        <h2>Filtering</h2>
    </div>
    <div class="row mb-3">
        <div class="col-3 d-flex">
            <label>Optimizer:</label>
            <input id='filterOptimizer' class="input" type="text">
        </div>
        <button class='button is-light is-info' id="sortButton">Sort by time <span class="sort-icon ml-3"></span></button>
    </div>
</div>
<div class="container" id="runs_list">
    {% for network_training in network_training_data %}
        <div class="accordion" id="accordion{{ network_training.id }}" data-app-version='{{network_training.naso_app_version}}' data-optimizer='{{network_training.hyper_parameters.optimizer.instance_type.name}}' data-time="{% get_metric network_training.final_metrics.metrics 'time' %}">
            <div class="card">
                <div class="card-header d-flex justify-content-between is-align-items-center" id="heading{{ network_training.id }}">
                    <h2 class="mb-0">
                        <button class="btn" type="button" data-toggle="collapse" data-target="#collapse{{ network_training.id }}" aria-expanded="true" aria-controls="collapse{{ network_training.id }}">
                            {{ network_training.network_config.name }}
                        </button>
                    </h2>
                    <div class='d-flex is-align-items-center'>
                        {% for metric in network_training.final_metrics.metrics %}
                            {% for attr_name in metric.metrics %}
                                <span class="mx-1 tag is-info is-light">{{ attr_name }}: {% get_attribute_tag metric.metrics attr_name %}</span>
                            {% endfor %}

                            {% if 'time' in metric %}
                                <span class="mx-1 tag is-primary is-light">time: {% get_attribute_tag metric 'time' %}</span>
                            {% endif %}
                        
                        {% endfor %}
                        <a class="button is-info ml-2 has-tooltip-arrow has-tooltip-left" href="{% url 'runs:new' %}?rerun={{network_training.id}}" data-tooltip='Dieses Experiment neu starten'>
                            <i class="fas fa-redo"></i>
                        </a>
                        <button class="button is-danger ml-2 delete-btn" data-target="#confirmDeleteModal" data-action="{% url 'runs:delete' network_training.id %}" data-item-id="{{ network_training.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                            
                    </div>
                </div>

                <div id="collapse{{ network_training.id }}" class="collapse" aria-labelledby="heading{{ network_training.id }}" data-parent="#accordion{{ network_training.id }}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <canvas class='h-100 w-100' id="chart{{ network_training.id }}"></canvas>
                            </div>
                            <div class="col-4 border-left p-5">
                                <div>
                                    <p>
                                        <span class='has-text-weight-bold'>Epochen:</span>
                                        {{ network_training.fit_parameters.epochs }}
                                    </p>
                                    <p>
                                        <span class='has-text-weight-bold'>Batch Size:</span>
                                        {{ network_training.fit_parameters.batch_size }}
                                    </p>
                                    <p>
                                        <span class='has-text-weight-bold'>Optimizer:</span>
                                        {{ network_training.hyper_parameters.optimizer.instance_type.name }}
                                    </p>
                                    <p>
                                        <span class='has-text-weight-bold'>Loss:</span>
                                        {{ network_training.hyper_parameters.loss.instance_type.name }}
                                    </p>
                                    <p>
                                        <span class='has-text-weight-bold'>NASO Version:</span>
                                        {{ network_training.naso_app_version }}
                                    </p>
                                </div>
                                <div>
                                    <a href="{% url 'runs:details' network_training.id %}"  class='mt-3 is-light button is-info'>Details</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    
                    var ctx{{ network_training.id }} = document.getElementById('chart{{ network_training.id }}').getContext('2d');
                    var data{{ network_training.id }} = [
                        // Define your chart data here based on network_training and its TrainingMetric objects
                        {% for training_metric in network_training.trainingmetric_set.all %}
                            {%  for metric in training_metric.metrics %}
                                {% if 'current' in metric %}
                                    // {"epoch": {% get_metric metric 'current' %}, 
                                    {"epoch": {{metric.current }} , 
                                    {% for metric_name in metric.metrics %}
                                        
                                        "{{metric_name}}":{% get_metric metric.metrics metric_name %},
                                        
                                    {% endfor %}
                                },
                                {% endif %}
                            {% endfor %}                            
                        {% endfor %}
                ];
                    var chart{{ network_training.id }} = new Chart(ctx{{ network_training.id }}, {
                        type: 'line', // Choose the appropriate chart type
                        data: {
                            labels: data{{ network_training.id }}.map(row => row.epoch),
                            datasets: [
                            {
                                label: 'loss',
                                data: data{{ network_training.id }}.map(row => row.loss)
                            },
                            {
                                label: 'accuracy',
                                data: data{{ network_training.id }}.map(row => row.accuracy)
                            }
                            ]
                        }
                    });

                    // Filter items by category
                    $('#filterOptimizer').on('change', function() {
                        var selectedOptimizer = $(this).val();
                        if (selectedOptimizer === 'all') {
                            $('#runs_list .accordion').show(); // Show all accordions when "All" is selected
                        } else {
                            $('#runs_list .accordion').hide(); // Hide all items
                            $('#runs_list .accordion[data-optimizer="' + selectedOptimizer + '"]').show(); // Show matching items
                        }
                    });

                    var ascending = true; // Flag to track sorting direction

                    $('#sortButton').on('click', function() {
                        // Toggle sorting direction
                        ascending = !ascending;

                        // Toggle the arrow icon
                        var sortIcon = $(this).find('.sort-icon');
                        if (ascending) {
                            sortIcon.text('↑'); // Up arrow
                        } else {
                            sortIcon.text('↓'); // Down arrow
                        }

                        $('#runs_list').find('.accordion').sort(function(a, b) {
                        var timeA = parseFloat($(a).data('time'));
                        var timeB = parseFloat($(b).data('time'));
                        return ascending ? timeA - timeB : timeB - timeA;
                    }).appendTo('#runs_list');
                    });

                    

                });
            </script>
    {% endfor %}
</div>
{% include 'components/delete_modal.html' %}
{% endblock content %}
